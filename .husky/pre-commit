# Check if database file is being committed
if git diff --cached --name-only | grep -q "^murphys\.db$"; then
  echo "ERROR: You're trying to commit murphys.db!"
  echo ""
  echo "This will overwrite production data. Please use migrations instead."
  echo ""
  echo "See DATABASE.md for how to make schema changes safely."
  echo ""
  echo "To unstage: git reset murphys.db"
  exit 1
fi

# Run tests before allowing commit
echo "Running tests..."
npm test
if [ $? -ne 0 ]; then
  echo ""
  echo "Tests failed! Commit blocked."
  echo ""
  echo "Please fix the failing tests before committing."
  echo "Run 'npm test' to see detailed test results."
  exit 1
fi

echo "All tests passed!"

# Check coverage thresholds (90% for all metrics)
# Can be bypassed with SKIP_COVERAGE_CHECK=1 for emergency commits
echo ""
echo "Checking coverage thresholds..."
node web/scripts/check-coverage.mjs
if [ $? -ne 0 ]; then
  echo ""
  echo "Coverage check failed! Commit blocked."
  echo ""
  echo "For emergency commits, use:"
  echo "  SKIP_COVERAGE_CHECK=1 git commit -m \"your message\""
  exit 1
fi

node web/scripts/sanitize-husky-hooks.mjs
npx lint-staged
