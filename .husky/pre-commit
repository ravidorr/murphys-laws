# Require CHANGELOG.md to be staged when there are other staged changes
if [ "$SKIP_CHANGELOG_CHECK" != "1" ]; then
  STAGED=$(git diff --cached --name-only)
  OTHER=$(echo "$STAGED" | grep -v "^CHANGELOG.md$")
  if [ -n "$OTHER" ] && ! echo "$STAGED" | grep -q "^CHANGELOG.md$"; then
    echo ""
    echo "ERROR: You have staged changes but CHANGELOG.md is not staged."
    echo ""
    echo "Add your changes under [Unreleased] in CHANGELOG.md and stage it:"
    echo "  git add CHANGELOG.md"
    echo ""
    echo "To bypass (emergency only): SKIP_CHANGELOG_CHECK=1 git commit ..."
    exit 1
  fi
fi

# Reminders (only in interactive terminals)
if [ -t 0 ]; then
  echo ""
  echo "=========================================="
  echo "  Pre-commit checklist:"
  echo "  1. Have you run a code review?"
  echo "     In Cursor, say: 'pre-commit review'"
  echo "  2. Have you updated CHANGELOG.md?"
  echo "     Add your changes under [Unreleased]"
  echo "=========================================="
  echo ""
  echo "Press Enter to continue, or Ctrl+C to cancel."
  read -r
fi

# Check if database file is being committed
if git diff --cached --name-only | grep -q "^murphys\.db$"; then
  echo "ERROR: You're trying to commit murphys.db!"
  echo ""
  echo "This will overwrite production data. Please use migrations instead."
  echo ""
  echo "See DATABASE.md for how to make schema changes safely."
  echo ""
  echo "To unstage: git reset murphys.db"
  exit 1
fi

# Same checks as CI (typecheck, lint, build:db) so commit is blocked if they would fail in CI
# Bypass with SKIP_CI_CHECK=1 for emergency commits
if [ "$SKIP_CI_CHECK" != "1" ]; then
  echo "Backend: typecheck, lint, build:db..."
  cd backend && npm run typecheck && npm run lint && npm run build:db
  if [ $? -ne 0 ]; then
    echo ""
    echo "Backend typecheck/lint/build failed! Commit blocked."
    echo "Bypass with: SKIP_CI_CHECK=1 git commit ..."
    exit 1
  fi
  cd ..

  echo ""
  echo "Web: typecheck, lint, lint:css, lint:html..."
  cd web && npm run typecheck && npm run lint && npm run lint:css && npm run lint:html
  if [ $? -ne 0 ]; then
    echo ""
    echo "Web typecheck/lint failed! Commit blocked."
    echo "Bypass with: SKIP_CI_CHECK=1 git commit ..."
    exit 1
  fi
  cd ..

  echo ""
fi
# Run tests before allowing commit
# Run backend tests (no coverage needed)
echo "Running backend tests..."
npm run test:backend
if [ $? -ne 0 ]; then
  echo ""
  echo "Backend tests failed! Commit blocked."
  echo ""
  echo "Please fix the failing tests before committing."
  exit 1
fi

# Run web tests with coverage (avoids running tests twice)
echo ""
echo "Running web tests with coverage..."
cd web && npm run test:coverage
if [ $? -ne 0 ]; then
  echo ""
  echo "Web tests failed! Commit blocked."
  echo ""
  echo "Please fix the failing tests before committing."
  exit 1
fi
cd ..

echo ""
echo "All tests passed!"

# Check coverage thresholds (90% for all metrics)
# Can be bypassed with SKIP_COVERAGE_CHECK=1 for emergency commits
echo ""
echo "Checking coverage thresholds..."
npx tsx web/scripts/check-coverage.ts --skip-test-run
if [ $? -ne 0 ]; then
  echo ""
  echo "Coverage check failed! Commit blocked."
  echo ""
  echo "For emergency commits, use:"
  echo "  SKIP_COVERAGE_CHECK=1 git commit -m \"your message\""
  exit 1
fi

npx tsx web/scripts/sanitize-husky-hooks.ts
npx lint-staged
