# Require CHANGELOG.md to be staged when there are other staged changes
if [ "$SKIP_CHANGELOG_CHECK" != "1" ]; then
  STAGED=$(git diff --cached --name-only)
  OTHER=$(echo "$STAGED" | grep -v "^CHANGELOG.md$")
  if [ -n "$OTHER" ] && ! echo "$STAGED" | grep -q "^CHANGELOG.md$"; then
    echo ""
    echo "ERROR: You have staged changes but CHANGELOG.md is not staged."
    echo ""
    echo "Add your changes under [Unreleased] in CHANGELOG.md and stage it:"
    echo "  git add CHANGELOG.md"
    echo ""
    echo "To bypass (emergency only): SKIP_CHANGELOG_CHECK=1 git commit ..."
    exit 1
  fi
fi

# Reminders (only in interactive terminals)
if [ -t 0 ]; then
  echo ""
  echo "=========================================="
  echo "  Pre-commit checklist:"
  echo "  1. Have you run a code review?"
  echo "     In Cursor, say: 'pre-commit review'"
  echo "  2. Have you updated CHANGELOG.md?"
  echo "     Add your changes under [Unreleased]"
  echo "=========================================="
  echo ""
  echo "Press Enter to continue, or Ctrl+C to cancel."
  read -r
fi

# Check if database file is being committed
if git diff --cached --name-only | grep -q "^murphys\.db$"; then
  echo "ERROR: You're trying to commit murphys.db!"
  echo ""
  echo "This will overwrite production data. Please use migrations instead."
  echo ""
  echo "See DATABASE.md for how to make schema changes safely."
  echo ""
  echo "To unstage: git reset murphys.db"
  exit 1
fi

# Run tests before allowing commit
# Run backend tests (no coverage needed)
echo "Running backend tests..."
npm run test:backend
if [ $? -ne 0 ]; then
  echo ""
  echo "Backend tests failed! Commit blocked."
  echo ""
  echo "Please fix the failing tests before committing."
  exit 1
fi

# Run web tests with coverage (avoids running tests twice)
echo ""
echo "Running web tests with coverage..."
cd web && npm run test:coverage
if [ $? -ne 0 ]; then
  echo ""
  echo "Web tests failed! Commit blocked."
  echo ""
  echo "Please fix the failing tests before committing."
  exit 1
fi
cd ..

echo ""
echo "All tests passed!"

# Check coverage thresholds (90% for all metrics)
# Can be bypassed with SKIP_COVERAGE_CHECK=1 for emergency commits
echo ""
echo "Checking coverage thresholds..."
node web/scripts/check-coverage.mjs --skip-test-run
if [ $? -ne 0 ]; then
  echo ""
  echo "Coverage check failed! Commit blocked."
  echo ""
  echo "For emergency commits, use:"
  echo "  SKIP_COVERAGE_CHECK=1 git commit -m \"your message\""
  exit 1
fi

node web/scripts/sanitize-husky-hooks.mjs
npx lint-staged
